<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Daily Bugle — Home</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    body { font-family: system-ui, sans-serif; margin: 0; background: #0f172a; color:#e2e8f0; }
    header, footer { padding: 12px 16px; background:#0b1220; border-bottom:1px solid #1f2937; }
    main { max-width: 860px; margin: 0 auto; padding: 16px; }
    .row { display:flex; gap: 16px; }
    .left { flex: 2; }
    .right { flex: 1; }
    .card { background:#111827; border:1px solid #1f2937; border-radius:12px; padding:14px; margin-bottom:12px; }
    a, a:visited { color:#93c5fd; text-decoration:none; }
    button { padding:8px 10px; border-radius:8px; border:0; background:#2563eb; color:#fff; cursor:pointer; }
    .hidden { display:none; }
    .ad { background:#0b1220; border:1px dashed #334155; min-height:90px; display:block; padding:10px; border-radius:10px; }
    .search-box { display:flex; gap:8px; margin-bottom:16px; }
    .search-box input { flex:1; padding:10px; border-radius:8px; border:1px solid #334155; background:#0b1220; color:#e2e8f0; }
    .search-box button { white-space:nowrap; }
  </style>
</head>
<body>
  <header class="row" style="justify-content:space-between;align-items:center;">
    <div><strong>Daily Bugle</strong></div>
    <div id="userbox">
      <a href="/dailybugle/login.html">Login / Register</a>
    </div>
  </header>

  <main class="row">
    <section class="left">
      <!-- Anonymous user view: list of stories -->
      <div id="anonymousView">
        <h2 id="sectionTitle">Latest stories</h2>
        <div class="search-box">
          <input type="text" id="searchInput" placeholder="Search stories..." />
          <button id="searchBtn">Search</button>
          <button id="clearBtn" class="hidden">Clear</button>
        </div>
        <div id="stories"></div>
      </div>

      <!-- Logged-in user view: one story at a time -->
      <div id="loggedInView" class="hidden">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px;">
          <button id="prevBtn">← Previous</button>
          <span id="storyCounter"></span>
          <button id="nextBtn">Next →</button>
        </div>
        
        <article class="card">
          <h1 id="storyTitle">Loading…</h1>
          <div id="storyTeaser" style="opacity:.85;margin-top:-6px"></div>
          <div id="storyCats" style="opacity:.75;font-size:.9em;margin-top:8px"></div>
          <div id="storyImageWrap" style="margin-top:12px;display:none">
            <img id="storyImage" style="max-width:100%;border-radius:8px" />
          </div>
          <div id="storyBody" style="margin-top:12px; white-space:pre-wrap;"></div>
        </article>

        <div id="editSection" class="card hidden">
          <h3>Edit article</h3>
          <label>Title <input id="editTitle"/></label><br/>
          <label>Teaser <input id="editTeaser"/></label><br/>
          <label>Body <textarea id="editBody" rows="8"></textarea></label><br/>
          <label>Categories (comma separated) <input id="editCategories"/></label><br/>
          <button id="saveEditBtn">Save changes</button>
          <span id="saveMsg" style="margin-left:10px; opacity:.85"></span>
        </div>

        <section class="card">
          <h3>Comments</h3>
          <div id="commentForm">
            <textarea id="commentText" rows="3" placeholder="Add a comment…"></textarea>
            <div style="margin-top:8px"><button id="postCommentBtn">Post</button></div>
          </div>
          <div id="commentsList"></div>
        </section>
      </div>
    </section>
    <aside class="right">
      <div id="adWrap" class="card">
        <div class="ad" id="adContainer">Loading ad…</div>
      </div>
    </aside>
  </main>

  <footer><small>&copy; Daily Bugle</small></footer>

  <script>
    const qs = (s, r=document) => r.querySelector(s);
    const storiesEl = qs("#stories");
    const userbox = qs("#userbox");
    const adWrap = qs("#adWrap"), adContainer = qs("#adContainer");
    
    let allArticles = [];
    let currentIndex = 0;
    let currentUser = null;

    async function api(path, opts={}) {
      const res = await fetch(path, { credentials:"include", ...opts });
      if (res.status === 204) return null;
      const ct = res.headers.get("content-type") || "";
      if (ct.includes("application/json")) return res.json();
      return res.text();
    }

    async function loadMe() {
      const res = await fetch("/dailybugle/api/auth/me", { credentials: "include" });
      if (!res.ok) return null;
      const { user } = await res.json();
      return user;
    }

    // For logged-in users: display one story at a time
    async function loadAllArticles() {
      const data = await api("/dailybugle/api/articles");
      allArticles = data.items || [];
      if (allArticles.length > 0) {
        await showArticleAtIndex(0);
      }
    }

    async function showArticleAtIndex(index) {
      if (index < 0 || index >= allArticles.length) return;
      currentIndex = index;
      const article = allArticles[index];

      qs("#storyTitle").textContent = article.title;
      qs("#storyTeaser").textContent = article.teaser || "";
      qs("#storyCats").textContent = "Categories: " + (article.categories||[]).join(", ");
      
      if (article.imageUrl) {
        qs("#storyImage").src = article.imageUrl;
        qs("#storyImageWrap").style.display = "block";
      } else {
        qs("#storyImageWrap").style.display = "none";
      }
      
      qs("#storyBody").textContent = article.body || "";
      qs("#storyCounter").textContent = `Story ${index + 1} of ${allArticles.length}`;

      // Update navigation buttons
      qs("#prevBtn").disabled = (index === 0);
      qs("#nextBtn").disabled = (index === allArticles.length - 1);

      // Check if current user is the author
      const isAuthor = currentUser && (currentUser.roles || []).includes("author");
      if (isAuthor) {
        qs("#editSection").classList.remove("hidden");
        qs("#editTitle").value = article.title || "";
        qs("#editTeaser").value = article.teaser || "";
        qs("#editBody").value = article.body || "";
        qs("#editCategories").value = (article.categories||[]).join(", ");
      } else {
        qs("#editSection").classList.add("hidden");
      }

      // Load comments for this article
      await loadCommentsForArticle(article.id);
    }

    async function loadCommentsForArticle(articleId) {
      const data = await api(`/dailybugle/api/comments/${encodeURIComponent(articleId)}/comments`);
      const box = qs("#commentsList");
      box.innerHTML = "";
      (data.items || []).forEach(c => {
        const el = document.createElement("div");
        el.style.margin = "10px 0";
        el.innerHTML = `<div style="opacity:.8;font-size:.9em">${new Date(c.createdAt).toLocaleString()}</div><div>${c.comment}</div>`;
        box.appendChild(el);
      });
    }

    async function api(path, opts={}) {
      const res = await fetch(path, { credentials:"include", ...opts });
      if (res.status === 204) return null;
      const ct = res.headers.get("content-type") || "";
      if (ct.includes("application/json")) return res.json();
      return res.text();
    }

    async function loadMe() {
      const res = await fetch("/dailybugle/api/auth/me", { credentials: "include" });
      if (!res.ok) return null;
      const { user } = await res.json();
      return user;
    }

    function storyCard(item, isLoggedIn) {
      const el = document.createElement("div");
      el.className = "card";
      const imageHtml = item.imageUrl ? `<img src="${item.imageUrl}" style="max-width:100%;border-radius:8px;margin-bottom:10px" />` : '';
      
      if (isLoggedIn) {
        el.innerHTML = `
          <a href="/dailybugle/story.html?id=${encodeURIComponent(item.id)}"><h3>${item.title}</h3></a>
          ${imageHtml}
          <p>${item.teaser ?? ""}</p>
          <div style="opacity:.75;font-size:.9em">Categories: ${(item.categories||[]).join(", ")}</div>
        `;
      } else {
        el.innerHTML = `
          <h3>${item.title}</h3>
          ${imageHtml}
          <p>${item.teaser ?? ""}</p>
          <div style="opacity:.75;font-size:.9em">Categories: ${(item.categories||[]).join(", ")}</div>
          <div style="margin-top:10px;opacity:.6;font-size:.9em">
            <a href="/dailybugle/login.html">Login to read full story</a>
          </div>
        `;
      }
      return el;
    }

    async function loadStories(isLoggedIn) {
      const data = await api("/dailybugle/api/articles");
      storiesEl.innerHTML = "";
      if (data.items && data.items.length > 0) {
        data.items.forEach(it => storiesEl.appendChild(storyCard(it, isLoggedIn)));
      } else {
        storiesEl.innerHTML = '<p style="opacity:.75">No stories found.</p>';
      }
    }

    async function searchStories(query, isLoggedIn) {
      const data = await api(`/dailybugle/api/search?q=${encodeURIComponent(query)}`);
      storiesEl.innerHTML = "";
      if (data.items && data.items.length > 0) {
        data.items.forEach(it => storiesEl.appendChild(storyCard(it, isLoggedIn)));
      } else {
        storiesEl.innerHTML = '<p style="opacity:.75">No results found.</p>';
      }
    }

    async function loadAd(contextArticleId) {
      const ad = await api("/dailybugle/api/ads");
      if (!ad || !ad.ad) { adWrap.classList.add("hidden"); return; }

      // Render creative
      adContainer.innerHTML = ad.ad.html;

      // Fire impression
      await fetch("/dailybugle/api/ad-events", {
        method:"POST",
        headers:{ "Content-Type":"application/json" },
        credentials:"include",
        body: JSON.stringify({ ad_id: ad.ad.id, article_id: contextArticleId || "home", event_type: "impression" })
      });

      // Capture click anywhere inside the ad container
      adContainer.addEventListener("click", async (e) => {
        try {
          await fetch("/dailybugle/api/ad-events", {
            method:"POST",
            headers:{ "Content-Type":"application/json" },
            credentials:"include",
            body: JSON.stringify({ ad_id: ad.ad.id, article_id: contextArticleId || "home", event_type: "click" })
          });
        } finally {
          window.location.href = ad.ad.clickUrl;
        }
      }, { once: true });
    }

    (async () => {
      const me = await loadMe();
      currentUser = me;
      const isLoggedIn = !!me;
      
      if (me) {
        const isAuthor = (me.roles || []).includes("author");
        userbox.innerHTML = `
          <span>Hi, ${me.username}</span>
          ${isAuthor ? ' &nbsp; <a href="/dailybugle/new_article.html">New Article</a>' : ''}
          &nbsp; <button id="logoutBtn">Logout</button>`;
        qs("#logoutBtn").onclick = async () => { await api("/dailybugle/api/auth/logout", { method:"POST" }); location.reload(); };
        
        // Show logged-in view
        qs("#anonymousView").classList.add("hidden");
        qs("#loggedInView").classList.remove("hidden");
        await loadAllArticles();

        // Navigation
        qs("#prevBtn").onclick = () => showArticleAtIndex(currentIndex - 1);
        qs("#nextBtn").onclick = () => showArticleAtIndex(currentIndex + 1);

        // Save edit
        qs("#saveEditBtn").onclick = async () => {
          const article = allArticles[currentIndex];
          const payload = {
            title: qs("#editTitle").value,
            teaser: qs("#editTeaser").value,
            body: qs("#editBody").value,
            categories: qs("#editCategories").value.split(",").map(s => s.trim()).filter(Boolean)
          };
          const res = await fetch(`/dailybugle/api/articles/${encodeURIComponent(article.id)}`, {
            method:"PATCH", headers:{ "Content-Type":"application/json" }, credentials:"include",
            body: JSON.stringify(payload)
          });
          qs("#saveMsg").textContent = res.ok ? "Saved." : "Failed.";
          if (res.ok) {
            // Reload articles to get updated data
            await loadAllArticles();
          }
        };

        // Post comment
        qs("#postCommentBtn").onclick = async () => {
          const text = qs("#commentText").value.trim();
          if (!text) return;
          const article = allArticles[currentIndex];
          const r = await fetch(`/dailybugle/api/comments/${encodeURIComponent(article.id)}/comments`, {
            method:"POST", headers:{ "Content-Type":"application/json" }, credentials:"include",
            body: JSON.stringify({ comment: text })
          });
          if (r.ok) {
            qs("#commentText").value = "";
            await loadCommentsForArticle(article.id);
          }
        };

        // Hide ads for authors
        if (isAuthor) {
          adWrap.classList.add("hidden");
        } else {
          await loadAd(null);
        }
      } else {
        // Anonymous user - show list view
        await loadAd(null);
        await loadStories(isLoggedIn);

        // Search functionality
        qs("#searchBtn").onclick = async () => {
          const query = qs("#searchInput").value.trim();
          if (query) {
            qs("#sectionTitle").textContent = `Search results for "${query}"`;
            qs("#clearBtn").classList.remove("hidden");
            await searchStories(query, isLoggedIn);
          }
        };

        qs("#searchInput").addEventListener("keypress", (e) => {
          if (e.key === "Enter") qs("#searchBtn").click();
        });

        qs("#clearBtn").onclick = async () => {
          qs("#searchInput").value = "";
          qs("#sectionTitle").textContent = "Latest stories";
          qs("#clearBtn").classList.add("hidden");
          await loadStories(isLoggedIn);
        };
      }
    })();
  </script>
</body>
</html>